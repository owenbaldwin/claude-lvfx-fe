<!-- Loading spinner -->
<div *ngIf="loading" class="text-center my-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2">Loading production breakdown data...</p>
</div>

<!-- Error message -->
<div *ngIf="error && !loading" class="alert alert-danger my-3" role="alert">
  <h4 class="alert-heading">Error Loading Data</h4>
  <p>{{ error }}</p>
  <hr>
  <p class="mb-0">
    Please check your connection and try again.
    <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadBreakdown()">Retry</button>
  </p>
</div>

<!-- Main content when data loaded -->
<div *ngIf="!loading && !error && filteredBreakdown" class="breakdown-container">
  <!-- Search and controls -->
  <div class="row mb-3">
    <div class="col-md-6 mb-2 mb-md-0">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search breakdown items..." 
          [(ngModel)]="searchText" 
          (input)="onSearchChange($event)"
        >
      </div>
    </div>
    <div class="col-md-6 text-md-end">
      <div class="btn-group">
        <button class="btn btn-outline-primary" (click)="toggleAllRows(true)">
          <i class="bi bi-arrows-expand"></i> Expand All
        </button>
        <button class="btn btn-outline-primary" (click)="toggleAllRows(false)">
          <i class="bi bi-arrows-collapse"></i> Collapse All
        </button>
        <button class="btn btn-outline-success" (click)="openAddSequenceModal()">
          <i class="bi bi-plus-circle"></i> Add Sequence
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk action bar -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body py-2">
          <div class="d-flex align-items-center justify-content-between flex-wrap">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll" [(ngModel)]="selectAllChecked" (change)="toggleSelectAll()">
              <label class="form-check-label" for="selectAll">
                Select All
              </label>
            </div>
            <div class="selection-counter small text-muted">
              <span *ngIf="selectedSequences.length + selectedScenes.length + selectedActionBeats.length + selectedShots.length > 0">
                Selected: {{selectedSequences.length}} sequences,
                {{selectedScenes.length}} scenes,
                {{selectedActionBeats.length}} action beats,
                {{selectedShots.length}} shots
              </span>
              <span *ngIf="selectedSequences.length + selectedScenes.length + selectedActionBeats.length + selectedShots.length === 0">
                No items selected
              </span>
            </div>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-primary" (click)="generateShots()" [disabled]="selectedActionBeats.length === 0 && selectedScenes.length === 0 && selectedSequences.length === 0">
                <i class="bi bi-camera-reels"></i> Generate Shots
              </button>
              <button class="btn btn-sm btn-outline-info" (click)="generateVfxAssumptions()" [disabled]="selectedShots.length === 0">
                <i class="bi bi-magic"></i> Generate VFX Assumptions
              </button>
              <button class="btn btn-sm btn-outline-success" (click)="generateCostEstimates()" [disabled]="selectedShots.length === 0">
                <i class="bi bi-currency-dollar"></i> Generate Cost Estimates
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Breakdown Table -->
  <div class="table-responsive">
    <table class="table table-hover breakdown-table">
      <thead class="table-light">
        <tr>
          <th width="40px"></th> <!-- Checkbox column -->
          <th width="40px"></th> <!-- Expand/collapse column -->
          <th>Name</th>
          <th>Type</th>
          <th>Details</th>
          <th width="120px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- No data message -->
        <tr *ngIf="filteredBreakdown.sequences.length === 0 && filteredBreakdown.unsequencedScenes.length === 0">
          <td colspan="6" class="text-center py-4">
            <p class="text-muted mb-2">No breakdown items found for this production.</p>
            <button class="btn btn-sm btn-primary" (click)="openAddSequenceModal()">
              <i class="bi bi-plus-circle"></i> Add First Sequence
            </button>
          </td>
        </tr>

        <!-- Sequences -->
        <ng-container *ngFor="let sequence of filteredBreakdown.sequences">
          <!-- Sequence row -->
          <app-breakdown-item
            [item]="sequence"
            [isExpanded]="expandedSequences[sequence.id]"
            [isSelected]="selectionService.isSequenceSelected(sequence.id)"
            (toggleExpand)="toggleSequence($event)"
            (toggleSelect)="handleItemSelection($event, 'sequence')"
            (editItem)="editItem($event)"
            (deleteItem)="deleteItem($event, 'sequence')"
            (addChild)="addChild($event, 'sequence')"
          ></app-breakdown-item>
          
          <!-- Scenes within sequence (shown when expanded) -->
          <ng-container *ngIf="expandedSequences[sequence.id]">
            <ng-container *ngFor="let scene of sequence.scenes">
              <!-- Scene row -->
              <app-breakdown-item
                [item]="scene"
                [level]="1"
                [isExpanded]="expandedScenes[scene.id]"
                [isSelected]="selectionService.isSceneSelected(scene.id)"
                (toggleExpand)="toggleScene($event)"
                (toggleSelect)="handleItemSelection($event, 'scene')"
                (editItem)="editItem($event)"
                (deleteItem)="deleteItem($event, 'scene')"
                (addChild)="addChild($event, 'scene')"
              ></app-breakdown-item>
              
              <!-- Action Beats within scene (shown when expanded) -->
              <ng-container *ngIf="expandedScenes[scene.id]">
                <ng-container *ngFor="let actionBeat of scene.actionBeats">
                  <!-- Action Beat row -->
                  <app-breakdown-item
                    [item]="actionBeat"
                    [level]="2"
                    [isExpanded]="expandedActionBeats[actionBeat.id]"
                    [isSelected]="selectionService.isActionBeatSelected(actionBeat.id)"
                    (toggleExpand)="toggleActionBeat($event)"
                    (toggleSelect)="handleItemSelection($event, 'actionBeat')"
                    (editItem)="editItem($event)"
                    (deleteItem)="deleteItem($event, 'actionBeat')"
                    (addChild)="addChild($event, 'actionBeat')"
                  ></app-breakdown-item>
                  
                  <!-- Shots within action beat (shown when expanded) -->
                  <ng-container *ngIf="expandedActionBeats[actionBeat.id]">
                    <ng-container *ngFor="let shot of actionBeat.shots">
                      <!-- Shot row -->
                      <app-breakdown-item
                        [item]="shot"
                        [level]="3"
                        [isExpanded]="expandedShots[shot.id]"
                        [isSelected]="selectionService.isShotSelected(shot.id)"
                        (toggleExpand)="toggleShot($event)"
                        (toggleSelect)="handleItemSelection($event, 'shot')"
                        (editItem)="editItem($event)"
                        (deleteItem)="deleteItem($event, 'shot')"
                      ></app-breakdown-item>
                    </ng-container>
                    
                    <!-- No shots message -->
                    <tr *ngIf="!actionBeat.shots || actionBeat.shots.length === 0">
                      <td colspan="6" class="text-center py-2 shot-placeholder">
                        <span class="text-muted small">No shots for this action beat</span>
                        <button class="btn btn-sm btn-link" (click)="addChild(actionBeat.id, 'actionBeat')">Add Shot</button>
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
                
                <!-- No action beats message -->
                <tr *ngIf="!scene.actionBeats || scene.actionBeats.length === 0">
                  <td colspan="6" class="text-center py-2 action-beat-placeholder">
                    <span class="text-muted small">No action beats for this scene</span>
                    <button class="btn btn-sm btn-link" (click)="addChild(scene.id, 'scene')">Add Action Beat</button>
                  </td>
                </tr>
              </ng-container>
            </ng-container>
            
            <!-- No scenes message -->
            <tr *ngIf="!sequence.scenes || sequence.scenes.length === 0">
              <td colspan="6" class="text-center py-2 scene-placeholder">
                <span class="text-muted small">No scenes in this sequence</span>
                <button class="btn btn-sm btn-link" (click)="addChild(sequence.id, 'sequence')">Add Scene</button>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Unsequenced Scenes section header -->
        <ng-container *ngIf="filteredBreakdown.unsequencedScenes && filteredBreakdown.unsequencedScenes.length > 0">
          <tr class="unsequenced-header">
            <td colspan="6" class="bg-light text-dark fw-bold">
              Unsequenced Scenes
            </td>
          </tr>
          
          <!-- Unsequenced Scenes -->
          <ng-container *ngFor="let scene of filteredBreakdown.unsequencedScenes">
            <!-- Scene row -->
            <app-breakdown-item
              [item]="scene"
              [isExpanded]="expandedScenes[scene.id]"
              [isSelected]="selectionService.isSceneSelected(scene.id)"
              (toggleExpand)="toggleScene($event)"
              (toggleSelect)="handleItemSelection($event, 'scene')"
              (editItem)="editItem($event)"
              (deleteItem)="deleteItem($event, 'scene')"
              (addChild)="addChild($event, 'scene')"
            ></app-breakdown-item>
            
            <!-- Action Beats for unsequenced scenes -->
            <ng-container *ngIf="expandedScenes[scene.id]">
              <ng-container *ngFor="let actionBeat of scene.actionBeats">
                <!-- Action Beat row -->
                <app-breakdown-item
                  [item]="actionBeat"
                  [level]="1"
                  [isExpanded]="expandedActionBeats[actionBeat.id]"
                  [isSelected]="selectionService.isActionBeatSelected(actionBeat.id)"
                  (toggleExpand)="toggleActionBeat($event)"
                  (toggleSelect)="handleItemSelection($event, 'actionBeat')"
                  (editItem)="editItem($event)"
                  (deleteItem)="deleteItem($event, 'actionBeat')"
                  (addChild)="addChild($event, 'actionBeat')"
                ></app-breakdown-item>
                
                <!-- Shots for unsequenced scene action beats -->
                <ng-container *ngIf="expandedActionBeats[actionBeat.id]">
                  <ng-container *ngFor="let shot of actionBeat.shots">
                    <!-- Shot row -->
                    <app-breakdown-item
                      [item]="shot"
                      [level]="2"
                      [isExpanded]="expandedShots[shot.id]"
                      [isSelected]="selectionService.isShotSelected(shot.id)"
                      (toggleExpand)="toggleShot($event)"
                      (toggleSelect)="handleItemSelection($event, 'shot')"
                      (editItem)="editItem($event)"
                      (deleteItem)="deleteItem($event, 'shot')"
                    ></app-breakdown-item>
                  </ng-container>
                  
                  <!-- No shots message -->
                  <tr *ngIf="!actionBeat.shots || actionBeat.shots.length === 0">
                    <td colspan="6" class="text-center py-2 shot-placeholder">
                      <span class="text-muted small">No shots for this action beat</span>
                      <button class="btn btn-sm btn-link" (click)="addChild(actionBeat.id, 'actionBeat')">Add Shot</button>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
              
              <!-- No action beats message -->
              <tr *ngIf="!scene.actionBeats || scene.actionBeats.length === 0">
                <td colspan="6" class="text-center py-2 action-beat-placeholder">
                  <span class="text-muted small">No action beats for this scene</span>
                  <button class="btn btn-sm btn-link" (click)="addChild(scene.id, 'scene')">Add Action Beat</button>
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>

<!-- Add Sequence Modal -->
<div class="modal fade" [ngClass]="{'show d-block': showSequenceModal}" tabindex="-1" role="dialog" aria-labelledby="addSequenceModalLabel" [attr.aria-hidden]="!showSequenceModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSequenceModalLabel">Add New Sequence</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeSequenceModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="sequenceForm">
          <div class="mb-3">
            <label for="sequenceName" class="form-label">Sequence Name</label>
            <input type="text" class="form-control" id="sequenceName" formControlName="name">
            <div *ngIf="sequenceForm.get('name')?.invalid && sequenceForm.get('name')?.touched" class="text-danger">
              Sequence name is required
            </div>
          </div>
          <div class="mb-3">
            <label for="sequencePrefix" class="form-label">Prefix</label>
            <input type="text" class="form-control" id="sequencePrefix" formControlName="prefix">
            <div *ngIf="sequenceForm.get('prefix')?.invalid && sequenceForm.get('prefix')?.touched" class="text-danger">
              Prefix is required
            </div>
            <small class="form-text text-muted">Usually a letter (e.g., "A", "B") or short code</small>
          </div>
          <div class="mb-3">
            <label for="insertAfter" class="form-label">Position</label>
            <select class="form-select" id="insertAfter" formControlName="insertAfter">
              <option [value]="0">At the beginning</option>
              <option *ngFor="let sequence of filteredBreakdown?.sequences" [value]="sequence?.order_number || 0">
                After {{sequence.name}}
              </option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeSequenceModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="addSequence()" [disabled]="sequenceForm.invalid">Add Sequence</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal backdrop -->
<div class="modal-backdrop fade show" *ngIf="showSequenceModal"></div>