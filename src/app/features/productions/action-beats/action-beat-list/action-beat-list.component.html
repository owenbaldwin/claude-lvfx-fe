<div>
  <!-- Loading spinner -->
  <!-- <div *ngIf="loading" class="text-center my-3">
    <mat-spinner diameter="40" class="mx-auto"></mat-spinner>
    <p class="mt-2">Loading scenes...</p>
  </div> -->

  <!-- Error message -->
  <!-- <div *ngIf="error" class="alert alert-danger">{{ error }}</div> -->


  <div *ngFor="let actionBeat of actionBeats">
    <ul
      class="breakdown-rows actionB-row"
      [attr.data-scene-id]="sceneId"
      [attr.data-sequence-id]="sequenceId">

      <!-- Checkbox -->
      <li style="width: 2%;">
        <input
          type="checkbox"
          class="individual-actionB-checkbox shot-checkbox"
          [class]="'check-actionB-sequence-' + sequenceId + ' check-actionB-scene-' + sceneId"
          [id]="'check-actionB-' + actionBeat.id"
          [name]="'check-actionB-' + actionBeat.id"
          [value]="actionBeat.id"
          [attr.data-actionbeat-id]="actionBeat.id"
          [attr.data-scene-id]="sceneId"
          [attr.data-sequence-id]="sequenceId" />
      </li>

      <!-- Collapse Trigger -->
      <a
        style="width: 8%;"
        class="table-collapse-btn"
        data-bs-toggle="collapse"
        [href]="'#collapse-actionB-' + actionBeat.id"
        role="button"
        aria-expanded="false"
        [attr.aria-controls]="'collapse-actionB-' + actionBeat.id">
        <li><h6>{{ sequencePrefix }}:{{ sceneNumber }}:{{ actionBeat.number }}</h6></li>
      </a>

      <!-- Type Icon -->
      <li style="width: 5%;">
        <button type="button" class="btn-transparent" data-bs-toggle="tooltip" [attr.title]="actionBeat.beat_type | titlecase">
          <i class="bi" [ngClass]="actionBeat.beat_type === 'action' ? 'bi-stars' : 'bi-chat-dots-fill'"></i>
        </button>
      </li>

      <li style="width: 5%;"></li>

      <!-- Description Display -->
      <li style="width: 20%;" class="inline-cell">
        <p *ngIf="actionBeat.beat_type === 'action'">
          {{ actionBeat.description }}
        </p>
        <p *ngIf="actionBeat.beat_type === 'dialogue'">
          <!-- {{
          (actionCharacters.find(c => c.action_beat_id === actionBeat.id)?.name || 'Unknown')
          }}: -->
          <em>{{ actionBeat.description }}</em>
        </p>
      </li>

      <li style="width: 5%;"></li>

      <!-- Characters Dropdown -->
      <li style="width: 5%;">
        <!-- TODO: ADD CHARACTERS!!!! -->
        <!-- <div class="dropdown">
          <button class="btn-transparent" data-bs-toggle="dropdown">
            <i class="bi bi-person-fill"></i>
            {{
            actionCharacters.filter(c => c.action_beat_id === actionBeat.id).length
            }}
          </button>
          <ul class="dropdown-menu">
            <li *ngFor="let c of actionCharacters.filter(c => c.action_beat_id === actionBeat.id)">
              <a class="dropdown-item">{{ c.name }}</a>
            </li>
          </ul>
        </div> -->
      </li>

      <li style="width: 15%;">
        <!-- version dropdown -->
        <select *ngIf="versionsMap[actionBeat.number]?.length" #versionSelect (change)="switchVersion(actionBeat, versionSelect.value)">
          <option *ngFor="let v of versionsMap[actionBeat.number]" [value]="v.id" [selected]="v.is_active">
            v{{ v.version_number || 1 }}
          </option>
        </select>
      </li>

      <!-- Options Dropdown -->
      <li style="width: 5%;">
        <!-- <div class="dropdown">
          <button
            class="btn btn-small"
            type="button"
            [id]="'seq-' + sequenceId + '-options'"
            data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-three-dots" style="font-size: 24px;"></i>
          </button> -->
          <app-crud-dropdown
            [entityLabel]="'Action Beat'"
            [elementId]="actionBeat.id || 0"
            [addLabel]="'Add New Shot'"
            (add)="openNewShotModal(actionBeat.id)"
            (edit)="openEditModal(actionBeat)"
            (version)="openNewVersionModal(actionBeat)"
            (delete)="deleteActionBeat(actionBeat.id!)">
          </app-crud-dropdown>
        <!-- </div> -->
      </li>
    </ul>
    <div
      class="collapse row-collapse"
      [id]="'collapse-actionB-' + actionBeat.id">
      <app-shot-list
        [actionBeatId]="actionBeat.id!"
        [actionBeatNumber]="actionBeat.number"
        [sceneId]="sceneId!"
        [sceneNumber]="sceneNumber"
        [sequenceId]="sequenceId"
        [sequencePrefix]="sequencePrefix"
        [productionId]="productionId">
      </app-shot-list>
    </div>
  </div>

  <p *ngIf="actionBeats.length === 0" class="text-center">No action beats available for this scene.</p>

  <!-- New Action Beat Modal -->
  <app-modal [title]="'Add New Action Beat'" [isOpen]="showNewActionBeatModal" (close)="closeNewActionBeatModal()">
    <app-action-beat-new
      [sceneId]="sceneId"
      [sequenceId]="sequenceId"
      [productionId]="productionId"
      (actionBeatCreated)="onActionBeatCreated()">
    </app-action-beat-new>
  </app-modal>

  <!-- Edit Action Beat Modal -->
  <app-modal [title]="'Edit Action Beat'" [isOpen]="showEditModal" (close)="showEditModal = false">
    <app-action-beat-edit
      [actionBeat]="selectedElement"
      [sequenceId]="sequenceId"
      [productionId]="productionId"
      [sceneId]="sceneId"
      (actionBeatUpdated)="onActionBeatUpdated()">
    </app-action-beat-edit>
  </app-modal>

  <!-- New Shot Modal -->
  <app-modal [title]="'Add New Shot'" [isOpen]="showNewShotModal" (close)="closeNewShotModal()">
    <app-shot-new
      [actionBeatId]="selectedActionBeatId"
      [sceneId]="sceneId"
      [sequenceId]="sequenceId"
      [productionId]="productionId"
      (shotCreated)="onShotCreated()">
    </app-shot-new>
  </app-modal>

  <!-- New Action Beat Version Modal -->
  <app-modal [title]="'New Version of Action Beat ' + selectedActionBeat?.number" [isOpen]="showNewVersionModal"
    (close)="showNewVersionModal = false">
    <app-action-beat-version
      [actionBeat]="selectedActionBeat!"
      [sceneId]="sceneId"
      [sequenceId]="sequenceId"
      [productionId]="productionId"
      (versionCreated)="onVersionCreated()">
    </app-action-beat-version>
  </app-modal>

  <!-- Debug Info (remove this in production) -->
  <div *ngIf="false" class="debug-info">
    Modal is {{ showNewActionBeatModal ? 'VISIBLE' : 'HIDDEN' }}
    Scene ID: {{ sceneId }}
  </div>
</div>
